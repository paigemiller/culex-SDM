---
title: "Methods of correction for biased sampling in species distribution modeling"
author: "Robert Richards, Paige Miller, Gio Righi"
date: "May 2, 2016"
output: pdf_document
---

##Introduction
Ecologists, managers, and public health oﬃcials use species distribution models (SDMs) to predict the likelihood of species presence across a landscape of importance. Construction of these models requires “training” data representing known locations where the species of interest is present and absent. Presence-absence data produced through systematic samples chosen unbiasedly from the landscape of interest are the gold standard in this training data. Unfortunately examples of such data sets are few and far between. Much more common are examples of “Presence-only” data, such as records from natural history museums or much citizen science data. Though presence-only records provide less information than systematic presence-absence records (and limit the types of models that can be used) this data format can provide distinct advantages as well. 

Notably, these methods are not subject to the measurement uncertainty associated with absence records. If a species is detected at a location then it is deﬁnitively present in that location at that time. If, however, a species is not detected at a given location that species may be genuinely absent, or simply have gone undetected by the researcher despite its presence. Often even true absences may bear the mark of dispersal barriers or preventive biotic interactions leading to areas that are environmentally habitable by the species being marked as absences. Though presence-only data can also bear the imprint of such non-environmental variables (species may be detected in sink habitats as a result of migration from permanently habitable source habitats) (Pulliam 2000), this burden is generally considered to weigh more heavily on absence data. Presence only data are not, however, without other issues for species distribution modelers. 

Generally, presence-only models rely on the assumption that presence data are sampled unbiasedly from the distribution of a species. Violation of this assumption can cause problems with both model ﬁtting and model evaluation (Hijmans 2012). A number of methods have been proposed for addressing this problem of spatial sampling bias. They tend to fall into two major categories: (1) Thinning, a process in which a subset of presence points is selected for model ﬁtting in such a way as to minimize spatial or environmental aggregation, and (2) accounting for bias within the model. The second method can be accomplished by bias weighting, in which points are assigned weights for model ﬁtting based on the inverse of their association with sampling bias (e.g. Syfert et al. 2013, Stolar and Nielsen 2014). Alternatively bias can be corrected within a model by fitting the likelihood of observing a species presence as a function of both environmental variables and “observer bias” variables. 

Explicitly correcting or accounting for bias is generally considered the preferable method both because it attempts to reconstitute the unbiased distribution for modeling and because it retains all training records. Unfortunately these methods can be difficult to realize with most data sets as they tend to require a baseline understanding of the way the sampling is biased spatially. This understanding is often derived from the bias observed in sampling distributions of other species in the same regions or basic assumptions about the way that researchers tend to sample (e.g. bias in favor of areas close to roads or population centers). In the absence of such understanding data thinning provides a “researcher behavior” free method of improving predictions in the presence of spatial sampling bias. 

Thinning addresses spatial bias from a different perspective. Rather than attempting to determine the nature of the sampling bias thinning removes aggregated points. In this way it reduces the spatial bias at a given scale at the cost of a smaller training sample. Thinning has been implemented and tested in a number of diﬀerent ways. The distinctions between these methods fall along 2 distinct axes: (1) the method (grid based, distance based, or cluster analysis based) used to thin the data points and (2) the axes (geographic or environmental) along which the thinning of points is performed (Fig 1). Likely the most common form of thinning performed in modern SDM is the type implemented in MaxEnt (the leading presence-background SDM). MaxEnt selects one presence point per grid-cell of the environmental covariate grid. This process can also be interpreted as MaxEnt assigning a presence or non-presence identity to each grid-cell based on whether a presence point is found inside of it. (Phillips 2006, something else too). Grid-based geographic ﬁltering has been used with other SDMs as well (examples). Boria et al. (2014) propose and test an alternative method of geographic thinning in which a minimum allowable distance between points is imposed on presence data using an algorithm that maximizes the total number of retained points given this constraint (see Methods for further details). 
Recently, eﬀorts have been made to identify which data processing methods, including Thinning (see Table 1), provide the best model performance in the presence of spatially biased data. Some focus on the merits of geographic thining (e.g Boria et al. 2014, Kramer-Schadt et al. 2013) while others attempt to compare performance across environmental and geographic methods (Varela et al. 2014, Fourcade et al. 2014). Results of such studies have been mixed. Varela et al. (2014) compare the relative performance of grid-based environmental and spatial thinning to ﬁnd the clear superiority of environmental methods. They themselves highlight, however, that this relative performance may be context speciﬁc. Their study comprised the Iberian peninsula, a particularly environmentally heterogeneous area. Environmental thinning may perform better in this setting because it retains a larger number of unique points in environmental space while geographic thinning will tend to discard neighboring points that are in fact very diﬀerent environmentally. Alternatively, spatial heterogeneity of environment may result in a spatial sampling bias not manifesting as a clear bias in environmental space. This interpretation would suggest that environmental thinning ought to be less able to correct the bias in the data. Interestingly, Fourcade et al. (2014), in a comparison of a number of diﬀerent methods for limiting the eﬀect of spatial sampling bias on MaxEnt modeling, found “Systematic Sampling”, a methodological equivalent of our geographic grid based thinning, to be the generally superior method. This discrepancy between results could be due to diﬀerences in the taxa modeled, the geographic region (North America for Fourcade et al.), or simply the fact that the latter group’s implementation of environmental thinning was a cluster analysis (choosing a single point from identified clusters, rather than grid based thinning. Though more work certainly remains to be done in this area, thinning performance is beginning to appear to be both system and implementation dependent. 

Relatively little effort has been made to assess the effect of resolution of thinning on model fit. Most thinning attempts, even those whose stated goal is to measure the effects of thinning, set a single resolution of thinning for all analyses (Boria et al. 2014, Varela et al. 2014, Fourcade et al. 2014, Phillips). We instead allow the resolution of our thinning methods to vary over a range in an effort to determine the effect of thinning distance on model fit. This process allows us to compare the performance of each individual model to the “ideal” thinning distance (the distance at which spatial autocorrelation is highest) and the model average of all thinning distances. Model averaging has been used to great effect in SDM both in the form of bootstrap aggregation (Breiman 1996, Drake 2014, Drake 2015) and of the combination of predictions of different modeling methods (Marmion et al. 2009). Therefore it is possible that if our “ideal” thinning distance should prove inconsistent in its performance a model averaging approach will outperform an arbitrarily chosen thinning distance. Model averaging approaches often significantly outperform even the best fit models (Marmion et al. 2009).
Here we make an initial attempt at applying the 2 primary data thinning methods across geographic and environmental space at a series of resolutions in an eﬀort to measure the overall performance of each method across 30 simulated species. We then apply the best performing methods from this simulation study to 2 members of the Culex mosquito species complex in Africa whose predicted distributions have serious public health implications for the spread of West Nile Virus.

##Methods
Environmental Data
Environmental covariate rasters were downloaded from the BIOCLIM database (Hijmans et al. 2005, http://www.worldclim.org/bioclim). Monthly temperature range variables were also constructed (Drake, unpublished work). Data were rescaled by subtracting the raster mean and dividing by the raster standard deviation. Variables that are ecdf transformed are not rescaled.
Simulated Species

The environmental distributions of N simulated species were generated using the generateRandomSp function in the R package virtualspecies using the first two principle components of our environmental covariates (Leroy et al. 2015). 2000 training presence points and 2000 testing presence and absence points were then drawn from the species’ projected distribution across the continent of Africa. The distribution of training presence points was then sampled from biasedly based on proximity to 3 major population centers () creating a biased dataset of 500 training presence points. This process was repeated to generate 30 unique simulated species on which to test data processing methods. 
Culex Data 

Presence records for 2 species of Culex mosquitoes (C. pipiens and C. quinquefasciatus) on the continent of Africa were collected in the Vector Map database (http://vectormap.si.edu/dataportal.htm). Records were initially reduced to unique geographic locations (

Data Processing
Spatial Thinning
Distance-based thinning was performed using an adaptation of the R package spThin (Aiello-Lammens et al. 2015). The thinning algorithm accepts a minimum allowable distance (x) between points, calculates the number of occurrence records within this distance for each presence point, and identiﬁes the record(s) with the greatest number of neighbors within x. One of these records is then eliminated at random and the process is repeated until no remaining point has a neighboer within x. Thinning was performed at a series of scales (x=.16 degrees, 1 degree, 5 degres) to assess the eﬀect of thinning distance on model output. Grid-based thinning was performed using the gridSample function in the R package dismo (Hijmans et al. 2015). We provide the function with a raster grid of a speciﬁc resolution (cell size) and (much like the MaxEnt functionality discussed above) one presence point is chosen at random in each grid cell. This type of thinning was performed at the resolution of the environmental variables (.1666 degrees) as well as lower resolutions (1 and 5 degrees). Due to the large spatial extent of Africa the actual distance in meters corresponding to a degree varies substantially latitudinally across the continent. 
Environmental thinning

We performed a principal components analysis (PCA) of the re-scaled baseline environmental data. Approximately 55% of the variation in environmental covariates was explained by the ﬁrst two principle components (Drake, unpublished work). Thus, we sought to test whether ﬁltering points in two-dimensional PCA space, deﬁned by the ﬁrst two principal components, is a viable option for correcting spatially biased data. Again two methods of thinning were tested: (1) distance thinning and (2) grid-based thinning. The implementations of these thinning methods were identical to those used for spatial thinning. 

Assessing optimal thinning resolution and Model Averaging
In order to further examine the effect of thinning resolution on model fit, we isolated environmental distance thinning as a good thinning method and performed a more thorough test of how a range of thinning distances influences model performance. We attempted, unsuccessfully, to determine an ideal thinning resolution based on linearized Ripley’s K analyses. As a result we instead fit models to points that were thinned at distances in PCA space of 0.25-5 increasing at increments of 0.25. Each of the models trained on these data sets was evaluated individually and their predictions were then averaged and the performance of this consensus model was then evaluated.

Species Distribution Models 
LOBAG-OC (Drake 2014) was the primary modeling method used. Unlike the more widely used MaxEnt LOBAG-OC is a true presence-only method in that the model is trained using exclusively the point presence data, with no requirement for randomly sampled background (or “pseudo-absence”) points. 

Model Evaluation
Models were evaluated using the 2000 presence-absence evaluation points drawn from each virtual species’ distribution. Area under the Receiver Operator Curve (AUC) values were calculated and for all filtering methods were converted into ΔAUC values:

representing the proportion of performance lost to bias that is regained through thinning (Fourcade).

Culex range predictions 
The ultimate goal of this work was to produce accurate maps of the distribution of members of the Culex species complex on the continent of Africa. As such we applied (OUR BEST METHOD) to the spatially aggregated occurrence data mentioned above to produce predicted species distributions for Culex pipiens and Culex quinquifasciatus. 

##RESULTS
Environmental Thinning vs. Spatial Thinning
ANOVA analysis revealed the ΔAUC of our 12 thinning methods (2 thinning spaces x 2 thinning methods x 3 thinning distances) significantly differed by Space (environmental or spatial, p<.0001) and Distance (p<.0001) . Post hoc Tukey analysis reveals that all significant differences between classes were either (1) environmental thinning methods significantly outperforming spatial thinning methods or (2) methods with a larger distance (lower resolution) outperforming methods performed in the same space with a smaller distance (higher resolution). A substantial amount of heterogeneity in model performance can nonetheless be seen across our 30 simulated species resulting in inconsistency in the best method (Figure). The best fit model for 20 species was based on data thinned in environmental space. Only 2 species had best models fit to data thinned at the highest resolution (shortest distance). 

```{r, }
load("~/../culex-SDM/SimulatedSpeciesTestingDAUC.Rdata")

colnames(DAUC) <- c("Env Distance (low res)", "Env Distance (medium res)", "Env Distance (high res)", 
    "Env grid (low res)", "Env grid (medium res)", "Env grid (high res)", 
    "Geo Distance (low res)", "Geo Distance (medium res)", "Geo Distance (hig res)", 
    "Geo grid (low res)", "Geo Grid (medium res)", "Geo Grid (high res)")

levelplot(DAUC, at=unique(c(seq(-5,0, length=100), seq(0,5, length=100))), col.regions=colorRampPalette(c("red", "white", "green")), scales=list(x=list(rot=70)), ylab="", xlab="Species")

```

```{r}
load("~/Desktop/culex-SDM/thinningData.RData")

DAUC<-(thinMat[,4:24 ]-thinMat[,3]) / (thinMat[,1] - thinMat[,3])

levelplot(DAUC, at=unique(c(seq(-5,0, length=100), seq(0,5, length=100))), col.regions=colorRampPalette(c("red", "white", "green")), scales=list(x=list(rot=70)), ylab="Environmental Thinning Distance", xlab="Species")

DAUCvec<-as.vector(DAUC[,1:20])
DAUCmatrix<-cbind(DAUCvec, c(rep(.2,10), rep(.45,10), rep(.7,10), rep(.95, 10), rep(1.2, 10), rep(1.45,10), rep(1.7,10), rep(1.95,10), rep(2.2,10), rep(2.45,10), rep(2.7,10), rep(2.95,10), rep(3.2,10), rep(3.45,10), rep(3.7,10), rep(3.95,10), rep(4.2,10), rep(4.45,10), rep(4.7,10),rep(4.95,10)))

colnames(DAUCmatrix)<-c("DAUC", 'distance')
DAUCmatrix<-data.frame(DAUCmatrix)
summary(lm(DAUC~distance, data=DAUCmatrix))
plot(x=DAUCmatrix$distance, y=DAUCmatrix$DAUC)

```

##Discussion 
This work highlights the relative superiority of data thinning in environmental space for ameliorating the effect of spatial sampling bias. We therefore agree with the results of Varela et al. () and extend them from simple grid based thinning to distance based thinning as well. Our conclusions differ from those of Fourcade et al. () who found “systematic sampling,” the equivalent of our geographic thinning, to be the superior method. This discrepancy likely stems from the use of cluster analysis for environmental thinning in that work. Clusters of points in environmental space were identified and then a single point was selected from each cluster. This may have led to the environmental thinning of Fourcade et al. () discarding far more points than our grid and distance based methods resulting in lower AUC values. This superiority of environmental thinning may be due to the fact that spatial thinning has the potential to discard points that, despite being close spatially, are quite environmentally distinct and therefore each offer substantial information (Varela et al. ). This may be particularly likely across a highly heterogeneous landscape. Alternatively, because our 3 chosen resolutions were relatively arbitrary, we may have simply chosen more ideal resolutions for environmental thinning than for geographic. Additionally the best fit model for 10 out of 30 simulated species was, nonetheless, based on spatially thinned data.  Therefore we tentatively recommend thinning spatially biased data in environmental space via either grid or distance methods. Alternatively analyses could thin in both environmental and geographic space and compare model predictions. 
