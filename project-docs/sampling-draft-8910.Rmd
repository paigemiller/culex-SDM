---
title: "ECOL 8910 - Sampling Bias in SDMs"
author: "Paige Miller, Robert Richards, Giovanni Righi"
date: "03/21/2016"
output: html_document
---

#Background: 

* Why SDMs? 
    + Model species niche for conservation purposes
    + Fundamental niche to inform invasive species
    + Climate change scenarios
* Major assumption for traditional SDMs is that the data used for callibration represent a random sample of the population being studied (Araujo & Guisan 2006)
* Ways that opportunistic observations could exhibit geographic or environmental bias:
    + museum and herbarium records
    + distance to Universities, towns
    + accesibility: difficult areas to collect samples from
    + naturalistic interest: national parks
* Methods to get around these issues/lack of consensus on which way to use: 
    + Interdependence of observations: correcting number of df, adding spatial autocorrelation term (Lechstein et al. 2002), resampling plots at sufficient spatial distance (Guissan & Theurillat 2000)
    + Manipulate the occurence data in order to remove the bias, by discarding or down-weighting records (de-biasing like in Dudik et al. 2005) (bias grids e.g. Syfert et al. 2013) across space; difficult if under-lying bias is unknown and if data has small sample sizes to begin with (Robbie's paper?, but see Shadt et al. 2013 recommends background manipulation to reduce overprediction or underprediction in certain areas, used simulated spp data). Can also remove occurences across environmental space. 
    + Simulate types of bias (Fourcade et al. 2014) which created 12 bias combinations with a virtual and 2 real species. Five methods of sampling bias correction were used to assess the improvement of modeled distribuition relative to original distribution using MAXENT ![Figure 1 from Fourcade et al. 2014 ](/home/pbmpb13/Documents/culex-SDM/project-docs/journal.pone.0097122.g001.png) Data is available with links in the paper. Even though their goal was to provide a comprehensive review on how to deal with sampling bias, I don't think they accomplished this. They found that SDM output didn't differ too much depending on correction method used BUT results differed a TON depending on evaluation method used (AUC, Dgeo, Denv, Gover see fig. 4)
    + Manipulate the background data: design the selection of the background data so they reflect the same sample selection bias as the occurence data, one way to do this is to examine records from other species to get an idea of survey efforts in the area (Philips et al. 2009)
* __Study goals..??__

#Methods:

* Data collection:
    + Building off of work from __Potential distributions of _Culex_ mosquitos__ 
```{r}
plot(pca)
```


```{r}
# load data with PCA of environmental variables
afr.pip<-pipiens.coords[which(pipiens.coords[,1]>-35&pipiens.coords[,1]<38&pipiens.coords[,2]>-20&pipiens.coords[,2]<50),]
# pipiens coordinates
plot(wrld_simpl)
points(afr.pip, col='red')
```

* Thinning data by including only unique lat-long points
```{r}
#subsetting data by unique coordinates
afr.pip.unique<-unique(afr.pip)
plot(africa.lines2)
points(afr.pip.unique, col="red")

#data frame of xy points
afr.pip.unique<-data.frame(afr.pip.unique)

#environmental data at unique points in geographical space
unique.x<-extract(environmental.data.rs, afr.pip.unique)
unique.x<-data.frame(unique.x[complete.cases(unique.x),]) #take out NAs
```

* Environmental filter: Gridded thinning
```{r}
unique.pca<-predict(pca,unique.x)
ID <- c(1:length(unique.pca[,1]))
unique.pca <- cbind(ID, unique.pca)
plot(unique.pca[,2:3])

#assign raster layer on top of unique pca to sample from 
r<-raster(xmn=min(unique.pca[,2]-1), xmx=max(unique.pca[,2]+1), ymn=min(unique.pca[,3]-1), ymx=max(unique.pca[,3]+1))
res(r)<-(.1) #size of grid squares
cell<-cellFromXY(r, unique.pca[,2:3])
dup<-duplicated(cell)
data.thin<- unique.pca[!dup,]
plot(data.thin[,2:3])
#coordinate in geographic space
pca.coords <- afr.pip.unique[data.thin[,1],] #coordinates of pca points 
pca.env<-extract(environmental.data.rs, pca.coords) #how is this right?? len(afr.pip.unique)=430 but unique.x was only 402, so how do they match up?

```

* Environmental filter: Distance thinning
```{r}
library(rgeos)
require(sp)
#function for proximity filtering
filterByProximity <- function(xy, dist, mapUnits = F) {
  #xy can be either a SpatialPoints or SPDF object, or a matrix
  #dist is in km if mapUnits=F, in mapUnits otherwise
  if (!mapUnits) {
    d <- spDists(xy,longlat=T)
  }
  if (mapUnits) {
    d <- spDists(xy[,2:3],longlat=F)
  }
  diag(d) <- NA
  close <- (d <= dist)
  diag(close) <- NA
  closePts <- which(close,arr.ind=T)
  discard <- matrix(nrow=2,ncol=2)
  if (nrow(closePts) > 0) {
    while (nrow(closePts) > 0) {
      if ((!paste(closePts[1,1],closePts[1,2],sep='_') %in% paste(discard[,1],discard[,2],sep='_')) & (!paste(closePts[1,2],closePts[1,1],sep='_') %in% paste(discard[,1],discard[,2],sep='_'))) {
        discard <- rbind(discard, closePts[1,])
        closePts <- closePts[-union(which(closePts[,1] == closePts[1,1]), which(closePts[,2] == closePts[1,1])),]
      }
    }
    discard <- discard[complete.cases(discard),]
    return(xy[-discard[,1],])
  }
  if (nrow(closePts) == 0) {
    return(xy)
  }
}

pts <- unique.pca[,2:3]
pts2 <- filterByProximity(pts,dist=2, mapUnits=T)
pts.ind<-unique.x[which(pts2[,1] %in% pts[,1]),]
```

* LoBag Models for each thinning
```{r}
# Unique
LOB1<-lobag.oc(unique.x, n.votes=250)
#sum votes
rastersum1<- predict(environmental.data.rs,LOB1[[1]])
for (i in 2:250)
{
  rasterpredict1<-predict(environmental.data.rs,LOB1[[i]])
  rastersum1<-rastersum1+rasterpredict1
}
rastermean.unique<-rastersum1/length(LOB1)

# Grid thin
LOB2<-lobag.oc(pca.env, n.votes=250)
rastersum2- predict(environmental.data.rs,LOB2[[1]])
for (i in 2:250)
{
  rasterpredict2<-predict(environmental.data.rs,LOB2[[i]])
  rastersum2<-rastersum2+rasterpredict2
}
rastermean.grid<-rastersum2/length(LOB2)

# Distance thin
LOB3<-lobag.oc(pts.ind, n.votes=250)
rastersum3<- predict(environmental.data.rs,LOB3[[1]])
for (i in 2:250)
{
  rasterpredict3<-predict(environmental.data.rs,LOB3[[i]])
  rastersum3<-rastersum3+rasterpredict3
}
rastermean.dist<-rastersum3/length(LOB3)
```


* Evaluation: d-metric or other?

#Results:
* Data points for each environmental thinning method:
```{r, echo=FALSE}
# Unique points
plot(africa.lines2)
points(afr.pip.unique, col="red")

# Gridded thinning
plot(africa.lines2)
points(pca.coords, col="red")

# Distance thinning
plot(africa.lines2)
##points() #still working on this
```

* Thinned points in PCA space
```{r, echo=FALSE}
# Unique points
plot(unique.pca[,2:3],add=T,col='blue',pch=20,cex=2, main="PCA: unique sampling locations")

# Grid thin points
plot(data.thin[,2:3],add=T,col='blue',pch=20,cex=2, main="PCA: grid thin points")

# Dist thin points
plot(pts2,add=T,col='blue',pch=20,cex=2, main="PCA: distance thin points")
```

* LoBag predictions of _C pip_ in Africa
```{r, echo=FALSE}
# Unique
plot(rastermean.unique)

# Grid 
plot(rastermean.grid)

# Distance
plot(rastermean.dist)
```

#Discussion:
* Broader distribution when we use grid thinning in pca space but not distance thinning in pca space
